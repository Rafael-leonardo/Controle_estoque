{% extends 'layout.html' %}
{% load widget_tweaks %}
{% load bootstrap %}

{% block conteudo %}
<div class="container">
    <div id="error-message" class="alert alert-danger" style="display: none;">
        <strong>Erro:</strong> Não foi possível adicionar o item. Verifique os campos.
    </div>

    <form method="POST" novalidate>
        {% csrf_token %}
        <legend>Estoque Entrada</legend>

        <div>
            {% for field in form.visible_fields %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {% render_field field class="form-control" %}
                </div>
            {% endfor %}
        </div>

        {{ formset.management_form }}
        
        <div class="row">
            <div class="col-sm-12">
                <legend style="border-bottom: 1px solid #e5e5e5;">Produtos</legend>
                <div id="estoque" class="form-inline">
                </div>
            </div>
        </div>

        <button type="button" id="add-item" class="btn btn-info" style="margin-top: 10px;">Adicionar</button>

        <div style="margin-top: 20px;">
            <button type="submit" class="btn btn-primary">Salvar</button>
            <a href="{% url 'estoque:estoque_entrada_list' %}" class="btn btn-danger">Cancelar</a>
        </div>
    </form>
</div>
{% endblock conteudo %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const estoqueContainer = document.getElementById('estoque');
        const totalForms = document.querySelector('#id_estoque-TOTAL_FORMS');
        const addItemButton = document.getElementById('add-item');
        const errorMessageDiv = document.getElementById('error-message');

        const emptyForm = `
            <div class="form-group" style="margin-top: 10px;">
                <label for="id_estoque-__prefix__-produto">Produto</label>
                <input type="text" name="estoque-__prefix__-produto" class="form-control" required>
                <label for="id_estoque-__prefix__-quantidade">Quantidade</label>
                <input type="number" name="estoque-__prefix__-quantidade" class="form-control" required>
                <!-- Outros campos do item do estoque podem ser aqui adicionados -->
            </div>
        `;

        addItemButton.addEventListener('click', function () {
            const formCount = parseInt(totalForms.value); 
            let newFormHtml = emptyForm.replace(/__prefix__/g, formCount);

            const newFormElement = document.createElement('div');
            newFormElement.classList.add('form-group');
            newFormElement.style.marginTop = '10px';
            newFormElement.innerHTML = newFormHtml;

            const produtoField = newFormElement.querySelector('input[name*="produto"]');
            const quantidadeField = newFormElement.querySelector('input[name*="quantidade"]');

            if (!produtoField.value || !quantidadeField.value) {
                errorMessageDiv.style.display = 'block'; 
                return; 
            } else {
                errorMessageDiv.style.display = 'none'; 
            }

            estoqueContainer.appendChild(newFormElement);

            totalForms.value = formCount + 1; 
        });
    });
</script>
{% endblock js %}
